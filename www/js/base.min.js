String.prototype.trim = function(){
  return this.replace(/(^\s*)|(\s*$)/g, "");
};
String.prototype.isnull = function(){
  var isnull = false;
  var val = this.trim();
  if(val == undefined || val == null || val.length == 0){
    isnull = true;
  }
  return isnull;
};
String.prototype.isemail = function(){
  var val = this.trim();
  var filter = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
  return filter.test(val) ? true : false;
};
var err = {
  show: function(name){
    this.clear();
    $("#"+name+'-err').show();
    $("#"+name+'-err').parents(".control-group").addClass("error");
  },
  internal: function(){
    $(".modal").modal("hide");
    $("#internal-err-panel").modal("show");
  },
  clear: function(){
    $(".err").hide();
    $(".control-group").removeClass("error");
    $("#internal-err-panel").modal("hide");
  }
};
var content = {
  resize: function(){
    $(".content_resize").css({"height":$(window).height()});
  }
};
var subpage = {
  resize: function(){
    $("#subpage .subpage_resize").css({"height":$(window).height()});
    $("#subpage .subpage_ctrol").css({"height":$(window).height()});
  },
  show: function(){
    var suboffset = $(".subpage_resize").width();
    var status = $("#subpage_button").data("status");
    if(status == "show"){
      $("#addfeed-panel").css("position","fixed");
      $("#subpage").animate({"left":"0px"},function(){
        $("#subpage_button").data("status","hide").html('<i class="icon-chevron-left"></i>');
      });
    } else if(status == "hide"){
      $("#addfeed-panel").css("position","absolute");
      $("#subpage").animate({"left":-suboffset},function(){
        $("#subpage_button").data("status","show").html('<i class="icon-chevron-right"></i>');
      });
    }
  }
};
var tab = {
  show: function(id){
    var pid = $("#param_content_td").val();
    if(pid > 0){
      $("#tr-"+pid).find("td").removeClass("active");
    }
    if(pid != id){
      $("#param_content_td").val(id);
      $("#tr-"+id).find("td").addClass("active");
    }
  },
  star: function(id){
    if($("#td-star-"+id).hasClass("td-star-e")){
      $("#td-star-"+id).removeClass("td-star-e").addClass("td-star-f");
    } else if($("#td-star-"+id).hasClass("td-star-f")){
      $("#td-star-"+id).removeClass("td-star-f").addClass("td-star-e");
    }
  }
};
var feeds = {
  show: function(){
    if($("#param_feeds_div").val() == "show"){
      $("#param_feeds_div").val('hide');
      $("#feeds_show_icon").removeClass("icon-chevron-right").addClass("icon-chevron-down");
    } else if($("#param_feeds_div").val() == "hide"){
      $("#param_feeds_div").val('show');
      $("#feeds_show_icon").removeClass("icon-chevron-down").addClass("icon-chevron-right");
    }
  }
};
var user = {
  data: new Object(),
  show: function(type){
    $("#after-panel").hide();
    $("#user-panel-button").show();
    if(type == "register"){
      $("#register-panel").show();
      $("#signin-panel").hide();
      $("#user-panel-title").html("register");
      $("#user-panel-button").html("register");
    } else if(type == "signin"){
      $("#register-panel").hide();
      $("#signin-panel").show();
      $("#user-panel-title").html("sign in");
      $("#user-panel-button").html("sign in");
    }
    k.register("enter", "user."+type+"()");
    $("#user-panel-button").data("call", type);
    $("#user-panel").modal("show");
  },
  hide: function(){
    $("#user-panel").modal("hide");
  },
  clear: function(){
    err.clear();
    $("#register-panel-email").val("");
    $("#signin-panel-email").val("");
    $("#signin-panel-pass").val("");
    $("[name='signin-panel-rememberme']:checked").attr("checked", false);
  },
  register: function(){
    this.data.email = $("#register-panel-email").val();
    if(this.data.email.isemail()){
      this.send("register");
    } else {
      err.show("register-email");
    }
  },
  signin: function(){
    this.data.email = $("#signin-panel-email").val();
    if(this.data.email.isemail()){
      this.send("signin");
    } else {
      err.show("signin-email");
    }
    this.data.pass = $("#signin-panel-pass").val();
  },
  send: function(type){
    err.clear();
    var posturl = "/" + type;
    $.ajax({
      type:     "POST",
      url:      posturl,
      dataType: "json",
      data:     this.data,
      success:  function(res){
        if(res.state == 0){
          if(type == "register"){
            user.after();
          }
        } else {
          window.location.reload();
        }
      },
      error:    function(XMLHttpRequest, textStatus, errorThrown){
        err.internal();
      }
    });
    return false;
  },
  after: function(){
    $("#after-panel").show();
    $("#register-panel").hide();
    $("#signin-panel").hide();
    $("#user-panel-button").hide();
    $("#user-panel-title").html("register successed");
  }
};
var k = {
  kibo: new Kibo(),
  register: function(key, call){
    this.kibo.down(key, function(){
      eval(call);
    });
  }
};
$(function(){
  //resize
  content.resize();
  subpage.resize();
  $(window).resize(function(){
    subpage.resize();
  });
  //scroll
  $(window).scroll(function(){
    $("#subpage").css({"top":$(window).scrollTop()});
  });
  $("#subpage_button").click(function(){
    subpage.show();
  });
  //change td active
  $(".td-col").click(function(){
    var id = $(this).data("id");
    tab.show(id);
  });
  //change td star
  $(".td-star").click(function(){
    var id = $(this).data("id");
    tab.star(id);
  });
  $("#user-panel-button").click(function(){
    var call = $(this).data("call");
    if(call != undefined && call != null){
      call = "user." + call + "()";
      eval(call);
    }
  });
  $("#user-panel-close").click(function(){
    user.clear();
  });
});